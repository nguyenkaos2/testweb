

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>26. Context managers &mdash; Python Tips 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Python Tips 0.1 documentation" href="index.html"/>
        <link rel="prev" title="25. Function caching" href="function_caching.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Python Tips
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="CaoNotes.html">1. *args and **kwargs</a></li>
<li class="toctree-l1"><a class="reference internal" href="args_and_kwargs.html">2. *args and **kwargs</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">3. Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="generators.html">4. Generators</a></li>
<li class="toctree-l1"><a class="reference internal" href="map_filter.html">5. Map, Filter and Reduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="set_-_data_structure.html">6. <code class="docutils literal"><span class="pre">set</span></code> Data Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="ternary_operators.html">7. Ternary Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="decorators.html">8. Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_&amp;_return.html">9. Global &amp; Return</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutation.html">10. Mutation</a></li>
<li class="toctree-l1"><a class="reference internal" href="__slots__magic.html">11. __slots__ Magic</a></li>
<li class="toctree-l1"><a class="reference internal" href="virtual_environment.html">12. Virtual Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="collections.html">13. Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="enumerate.html">14. Enumerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_introspection.html">15. Object introspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="comprehensions.html">16. Comprehensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="exceptions.html">17. Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="lambdas.html">18. Lambdas</a></li>
<li class="toctree-l1"><a class="reference internal" href="one_liners.html">19. One-Liners</a></li>
<li class="toctree-l1"><a class="reference internal" href="for_-_else.html">20. For - Else</a></li>
<li class="toctree-l1"><a class="reference internal" href="python_c_extension.html">21. Python C extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="open_function.html">22. <code class="docutils literal"><span class="pre">open</span></code> Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="targeting_python_2_3.html">23. Targeting Python 2+3</a></li>
<li class="toctree-l1"><a class="reference internal" href="coroutines.html">24. Coroutines</a></li>
<li class="toctree-l1"><a class="reference internal" href="function_caching.html">25. Function caching</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">26. Context managers</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#implementing-context-manager-as-a-class">26.1. Implementing Context Manager as a Class:</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handling-exceptions">26.2. Handling exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementing-a-context-manager-as-a-generator">26.3. Implementing a Context Manager as a Generator</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Python Tips</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>26. Context managers</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/context_managers.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="context-managers">
<h1>26. Context managers<a class="headerlink" href="#context-managers" title="Permalink to this headline">¶</a></h1>
<p>Context managers allow you to allocate and release resources precisely
when you want to. The most widely used example of context managers is
the <code class="docutils literal"><span class="pre">with</span></code> statement. Suppose you have two related operations which
you’d like to execute as a pair, with a block of code in between.
Context managers allow you to do specifically that. For example:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;some_file&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened_file</span><span class="p">:</span>
    <span class="n">opened_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Hola!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The above code opens the file, writes some data to it and then closes
it. If an error occurs while writing the data to the file, it tries to
close it. The above code is equivalent to:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;some_file&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Hola!&#39;</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>While comparing it to the first example we can see that a lot of
boilerplate code is eliminated just by using <code class="docutils literal"><span class="pre">with</span></code>. The main
advantage of using a <code class="docutils literal"><span class="pre">with</span></code> statement is that it makes sure our file
is closed without paying attention to how the nested block exits.</p>
<p>A common use case of context managers is locking and unlocking resources
and closing opened files (as I have already showed you).</p>
<p>Let’s see how we can implement our own Context Manager. This would allow
us to understand exactly what’s going on behind the scenes.</p>
<div class="section" id="implementing-context-manager-as-a-class">
<h2>26.1. Implementing Context Manager as a Class:<a class="headerlink" href="#implementing-context-manager-as-a-class" title="Permalink to this headline">¶</a></h2>
<p>At the very least a context manager has an <code class="docutils literal"><span class="pre">__enter__</span></code> and
<code class="docutils literal"><span class="pre">__exit__</span></code> methods defined. Let’s make our own file opening Context
Manager and learn the basics.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Just by defining <code class="docutils literal"><span class="pre">__enter__</span></code> and <code class="docutils literal"><span class="pre">__exit__</span></code> methods we can use it in
a <code class="docutils literal"><span class="pre">with</span></code> statement. Let’s try:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;demo.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened_file</span><span class="p">:</span>
    <span class="n">opened_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Hola!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Our <code class="docutils literal"><span class="pre">__exit__</span></code> function accepts three arguments. They are required by
every <code class="docutils literal"><span class="pre">__exit__</span></code> method which is a part of a Context Manager class.
Let’s talk about what happens under-the-hood.</p>
<ol class="arabic simple">
<li>The <code class="docutils literal"><span class="pre">with</span></code> statement stores the <code class="docutils literal"><span class="pre">__exit__</span></code> method of <code class="docutils literal"><span class="pre">File</span></code>
class.</li>
<li>It calls the <code class="docutils literal"><span class="pre">__enter__</span></code> method of <code class="docutils literal"><span class="pre">File</span></code> class.</li>
<li><code class="docutils literal"><span class="pre">__enter__</span></code> method opens the file and returns it.</li>
<li>the opened file handle is passed to <code class="docutils literal"><span class="pre">opened_file</span></code>.</li>
<li>we write to the file using <code class="docutils literal"><span class="pre">.write()</span></code></li>
<li><code class="docutils literal"><span class="pre">with</span></code> statement calls the stored <code class="docutils literal"><span class="pre">__exit__</span></code> method.</li>
<li>the <code class="docutils literal"><span class="pre">__exit__</span></code> method closes the file.</li>
</ol>
</div>
<div class="section" id="handling-exceptions">
<h2>26.2. Handling exceptions<a class="headerlink" href="#handling-exceptions" title="Permalink to this headline">¶</a></h2>
<p>We did not talk about the <code class="docutils literal"><span class="pre">type</span></code>, <code class="docutils literal"><span class="pre">value</span></code> and <code class="docutils literal"><span class="pre">traceback</span></code>
arguments of the <code class="docutils literal"><span class="pre">__exit__</span></code> method. Between the 4th and 6th step, if
an exception occurs, Python passes the type, value and traceback of the
exception to the <code class="docutils literal"><span class="pre">__exit__</span></code> method. It allows the <code class="docutils literal"><span class="pre">__exit__</span></code> method
to decide how to close the file and if any further steps are required.
In our case we are not paying any attention to them.</p>
<p>What if our file object raises an exception? We might be trying to
access a method on the file object which it does not supports. For
instance:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;demo.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened_file</span><span class="p">:</span>
    <span class="n">opened_file</span><span class="o">.</span><span class="n">undefined_function</span><span class="p">(</span><span class="s1">&#39;Hola!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Let’s list down the steps which are taken by the <code class="docutils literal"><span class="pre">with</span></code> statement when
an error is encountered.</p>
<ol class="arabic simple">
<li>It passes the type, value and traceback of the error to the
<code class="docutils literal"><span class="pre">__exit__</span></code> method.</li>
<li>It allows the <code class="docutils literal"><span class="pre">__exit__</span></code> method to handle the exception.</li>
<li>If <code class="docutils literal"><span class="pre">__exit__</span></code> returns True then the exception was gracefully
handled.</li>
<li>If anything else than True is returned by the <code class="docutils literal"><span class="pre">__exit__</span></code> method then
an exception is raised by the <code class="docutils literal"><span class="pre">with</span></code> statement.</li>
</ol>
<p>In our case the <code class="docutils literal"><span class="pre">__exit__</span></code> method returns <code class="docutils literal"><span class="pre">None</span></code> (when no return
statement is encountered then the method returns <code class="docutils literal"><span class="pre">None</span></code>). Therefore, the
<code class="docutils literal"><span class="pre">with</span></code> statement raises the exception.</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">2</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">AttributeError</span><span class="p">:</span> <span class="s1">&#39;file&#39;</span> <span class="nb">object</span> <span class="n">has</span> <span class="n">no</span> <span class="n">attribute</span> <span class="s1">&#39;undefined_function&#39;</span>
</pre></div>
</div>
<p>Let’s try handling the exception in the <code class="docutils literal"><span class="pre">__exit__</span></code> method:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Exception has been handled&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

<span class="k">with</span> <span class="n">File</span><span class="p">(</span><span class="s1">&#39;demo.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opened_file</span><span class="p">:</span>
    <span class="n">opened_file</span><span class="o">.</span><span class="n">undefined_function</span><span class="p">()</span>

<span class="c1"># Output: Exception has been handled</span>
</pre></div>
</div>
<p>Our <code class="docutils literal"><span class="pre">__exit__</span></code> method returned True, therefore no exception was raised
by the <code class="docutils literal"><span class="pre">with</span></code> statement.</p>
<p>This is not the only way to implement context managers. There is another
way and we will be looking at it in this next section.</p>
</div>
<div class="section" id="implementing-a-context-manager-as-a-generator">
<h2>26.3. Implementing a Context Manager as a Generator<a class="headerlink" href="#implementing-a-context-manager-as-a-generator" title="Permalink to this headline">¶</a></h2>
<p>We can also implement Context Managers using decorators and generators.
Python has a contextlib module for this very purpose. Instead of a
class, we can implement a Context Manager using a generator function.
Let’s see a basic, useless example:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="k">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">open_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">f</span>
    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Okay! This way of implementing Context Managers appears to be more
intuitive and easy. However, this method requires some knowledge about
generators, yield, and decorators. In this example we have not caught any
exceptions which might occur. It works in mostly the same way as the
previous method.</p>
<p>Let’s dissect this method a little.</p>
<ol class="arabic simple">
<li>Python encounters the <code class="docutils literal"><span class="pre">yield</span></code> keyword. Due to this it creates a
generator instead of a normal function.</li>
<li>Due to the decoration, contextmanager is called with the function
name (open_file) as it’s argument.</li>
<li>The <code class="docutils literal"><span class="pre">contextmanager</span></code> function returns the generator wrapped by the
<code class="docutils literal"><span class="pre">GeneratorContextManager</span></code> object.</li>
<li>The <code class="docutils literal"><span class="pre">GeneratorContextManager</span></code> is assigned to the <code class="docutils literal"><span class="pre">open_file</span></code>
function. Therefore, when we later call <code class="docutils literal"><span class="pre">open_file</span></code> function, we
are actually calling the <code class="docutils literal"><span class="pre">GeneratorContextManager</span></code> object.</li>
</ol>
<p>So now that we know all this, we can use the newly generated Context
Manager like this:</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">open_file</span><span class="p">(</span><span class="s1">&#39;some_file&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;hola!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="function_caching.html" class="btn btn-neutral" title="25. Function caching" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Muhammad Yasoob Ullah Khalid.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>