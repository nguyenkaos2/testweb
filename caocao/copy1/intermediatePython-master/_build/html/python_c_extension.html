

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>21. Python C extensions &mdash; Python Tips 0.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Python Tips 0.1 documentation" href="index.html"/>
        <link rel="next" title="22. open Function" href="open_function.html"/>
        <link rel="prev" title="20. For - Else" href="for_-_else.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Python Tips
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="CaoNotes.html">1. *args and **kwargs</a></li>
<li class="toctree-l1"><a class="reference internal" href="args_and_kwargs.html">2. *args and **kwargs</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">3. Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="generators.html">4. Generators</a></li>
<li class="toctree-l1"><a class="reference internal" href="map_filter.html">5. Map, Filter and Reduce</a></li>
<li class="toctree-l1"><a class="reference internal" href="set_-_data_structure.html">6. <code class="docutils literal"><span class="pre">set</span></code> Data Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="ternary_operators.html">7. Ternary Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="decorators.html">8. Decorators</a></li>
<li class="toctree-l1"><a class="reference internal" href="global_&amp;_return.html">9. Global &amp; Return</a></li>
<li class="toctree-l1"><a class="reference internal" href="mutation.html">10. Mutation</a></li>
<li class="toctree-l1"><a class="reference internal" href="__slots__magic.html">11. __slots__ Magic</a></li>
<li class="toctree-l1"><a class="reference internal" href="virtual_environment.html">12. Virtual Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="collections.html">13. Collections</a></li>
<li class="toctree-l1"><a class="reference internal" href="enumerate.html">14. Enumerate</a></li>
<li class="toctree-l1"><a class="reference internal" href="object_introspection.html">15. Object introspection</a></li>
<li class="toctree-l1"><a class="reference internal" href="comprehensions.html">16. Comprehensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="exceptions.html">17. Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="lambdas.html">18. Lambdas</a></li>
<li class="toctree-l1"><a class="reference internal" href="one_liners.html">19. One-Liners</a></li>
<li class="toctree-l1"><a class="reference internal" href="for_-_else.html">20. For - Else</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">21. Python C extensions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ctypes">21.1. CTypes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#swig">21.2. SWIG</a></li>
<li class="toctree-l2"><a class="reference internal" href="#python-c-api">21.3. Python/C API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="open_function.html">22. <code class="docutils literal"><span class="pre">open</span></code> Function</a></li>
<li class="toctree-l1"><a class="reference internal" href="targeting_python_2_3.html">23. Targeting Python 2+3</a></li>
<li class="toctree-l1"><a class="reference internal" href="coroutines.html">24. Coroutines</a></li>
<li class="toctree-l1"><a class="reference internal" href="function_caching.html">25. Function caching</a></li>
<li class="toctree-l1"><a class="reference internal" href="context_managers.html">26. Context managers</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Python Tips</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>21. Python C extensions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/python_c_extension.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="python-c-extensions">
<h1>21. Python C extensions<a class="headerlink" href="#python-c-extensions" title="Permalink to this headline">¶</a></h1>
<p>An interesting feature offered to developers by the CPython
implementation is the ease of interfacing C code to Python.</p>
<p>There are three key methods developers use to call C functions from
their python code - <code class="docutils literal"><span class="pre">ctypes</span></code>, <code class="docutils literal"><span class="pre">SWIG</span></code> and <code class="docutils literal"><span class="pre">Python/C</span> <span class="pre">API</span></code>. Each
method comes with it’s own merits and demerits.</p>
<p>Firstly, why would you want to interface C with Python?</p>
<p>A few common reasons are :</p>
<ul class="simple">
<li>You want speed and you know C is about 50x faster than Python.</li>
<li>Certain legacy C libraries work just as well as you want them to, so you don’t want to rewrite them in python.</li>
<li>Certain low level resource access - from memory to file interfaces.</li>
<li>Just because you want to.</li>
</ul>
<div class="section" id="ctypes">
<h2>21.1. CTypes<a class="headerlink" href="#ctypes" title="Permalink to this headline">¶</a></h2>
<p>The Python <a class="reference external" href="https://docs.python.org/2/library/ctypes.html">ctypes
module</a> is probably
the easiest way to call C functions from Python. The ctypes module
provides C compatible data types and functions to load DLLs so that
calls can be made to C shared libraries without having to modify them.
The fact that the C side needn’t be touched adds to the simplicity of
this method.</p>
<p><strong>Example</strong></p>
<p>Simple C code to add two numbers, save it as <code class="docutils literal"><span class="pre">add.c</span></code></p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">sample</span> <span class="n">C</span> <span class="n">file</span> <span class="n">to</span> <span class="n">add</span> <span class="mi">2</span> <span class="n">numbers</span> <span class="o">-</span> <span class="nb">int</span> <span class="ow">and</span> <span class="n">floats</span>

<span class="c1">#include &lt;stdio.h&gt;</span>

<span class="nb">int</span> <span class="n">add_int</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">);</span>
<span class="nb">float</span> <span class="n">add_float</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">);</span>

<span class="nb">int</span> <span class="n">add_int</span><span class="p">(</span><span class="nb">int</span> <span class="n">num1</span><span class="p">,</span> <span class="nb">int</span> <span class="n">num2</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">num1</span> <span class="o">+</span> <span class="n">num2</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">float</span> <span class="n">add_float</span><span class="p">(</span><span class="nb">float</span> <span class="n">num1</span><span class="p">,</span> <span class="nb">float</span> <span class="n">num2</span><span class="p">){</span>
    <span class="k">return</span> <span class="n">num1</span> <span class="o">+</span> <span class="n">num2</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next compile the C file to a <code class="docutils literal"><span class="pre">.so</span></code> file (DLL in windows) This will
generate an adder.so file.</p>
<div class="code bash highlight-default"><div class="highlight"><pre><span></span>#For Linux
$  gcc -shared -Wl,-soname,adder -o adder.so -fPIC add.c

#For Mac
$ gcc -shared -Wl,-install_name,adder.so -o adder.so -fPIC add.c
</pre></div>
</div>
<p>Now in your python code -</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ctypes</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1">#load the shared object file</span>
<span class="n">adder</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="s1">&#39;./adder.so&#39;</span><span class="p">)</span>

<span class="c1">#Find sum of integers</span>
<span class="n">res_int</span> <span class="o">=</span> <span class="n">adder</span><span class="o">.</span><span class="n">add_int</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Sum of 4 and 5 = &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">res_int</span><span class="p">)</span>

<span class="c1">#Find sum of floats</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">c_float</span><span class="p">(</span><span class="mf">5.5</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">c_float</span><span class="p">(</span><span class="mf">4.1</span><span class="p">)</span>

<span class="n">add_float</span> <span class="o">=</span> <span class="n">adder</span><span class="o">.</span><span class="n">add_float</span>
<span class="n">add_float</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_float</span>
<span class="nb">print</span> <span class="s2">&quot;Sum of 5.5 and 4.1 = &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">add_float</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
<p>And the output is as follows</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Sum</span> <span class="n">of</span> <span class="mi">4</span> <span class="ow">and</span> <span class="mi">5</span> <span class="o">=</span> <span class="mi">9</span>
<span class="n">Sum</span> <span class="n">of</span> <span class="mf">5.5</span> <span class="ow">and</span> <span class="mf">4.1</span> <span class="o">=</span>  <span class="mf">9.60000038147</span>
</pre></div>
</div>
<p>In this example the C file is self explanatory - it contains two
functions, one to add two integers and another to add two floats.</p>
<p>In the python file, first the ctypes module is imported. Then the CDLL
function of the ctypes module is used to load the shared lib file we
created. The functions defined in the C lib are now available to us via
the <code class="docutils literal"><span class="pre">adder</span></code> variable. When <code class="docutils literal"><span class="pre">adder.add_int()</span></code> is called, internally a
call is made to the <code class="docutils literal"><span class="pre">add_int</span></code> C function. The ctypes interface allows
us to use native python integers and strings by default while calling
the C functions.</p>
<p>For other types such as boolean or float, we have to use the correct
ctypes. This is seen while passing parameters to the
<code class="docutils literal"><span class="pre">adder.add_float()</span></code>. We first create the required c_float types from
python decimal values, and then use them as arguments to the C code.
This method is simple and clean, but limited. For example it’s not
possible to manipulate objects on the C side.</p>
</div>
<div class="section" id="swig">
<h2>21.2. SWIG<a class="headerlink" href="#swig" title="Permalink to this headline">¶</a></h2>
<p>Simplified Wrapper and Interface Generator, or SWIG for short is another
way to interface C code to Python. In this method, the developer must
develop an extra interface file which is an input to SWIG (the command
line utility).</p>
<p>Python developers generally don’t use this method, because it is in most
cases unnecessarily complex. This is a great method when you have a
C/C++ code base, and you want to interface it to many different
languages.</p>
<p><strong>Example</strong> (from the <a class="reference external" href="http://www.swig.org/tutorial.html">SWIG website</a> )</p>
<p>The C code, <code class="docutils literal"><span class="pre">example.c</span></code> that has a variety of functions and variables</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="c1">#include &lt;time.h&gt;</span>
<span class="n">double</span> <span class="n">My_variable</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">;</span>

<span class="nb">int</span> <span class="n">fact</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">return</span> <span class="n">n</span><span class="o">*</span><span class="n">fact</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">my_mod</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">%</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">char</span> <span class="o">*</span><span class="n">get_time</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">time_t</span> <span class="n">ltime</span><span class="p">;</span>
    <span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ltime</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ctime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ltime</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The interface file - this will remain the same irrespective of the
language you want to port your C code to :</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">example</span><span class="o">.</span><span class="n">i</span> <span class="o">*/</span>
 <span class="o">%</span><span class="n">module</span> <span class="n">example</span>
 <span class="o">%</span><span class="p">{</span>
 <span class="o">/*</span> <span class="n">Put</span> <span class="n">header</span> <span class="n">files</span> <span class="n">here</span> <span class="ow">or</span> <span class="n">function</span> <span class="n">declarations</span> <span class="n">like</span> <span class="n">below</span> <span class="o">*/</span>
 <span class="n">extern</span> <span class="n">double</span> <span class="n">My_variable</span><span class="p">;</span>
 <span class="n">extern</span> <span class="nb">int</span> <span class="n">fact</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">);</span>
 <span class="n">extern</span> <span class="nb">int</span> <span class="n">my_mod</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">);</span>
 <span class="n">extern</span> <span class="n">char</span> <span class="o">*</span><span class="n">get_time</span><span class="p">();</span>
 <span class="o">%</span><span class="p">}</span>

 <span class="n">extern</span> <span class="n">double</span> <span class="n">My_variable</span><span class="p">;</span>
 <span class="n">extern</span> <span class="nb">int</span> <span class="n">fact</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">);</span>
 <span class="n">extern</span> <span class="nb">int</span> <span class="n">my_mod</span><span class="p">(</span><span class="nb">int</span> <span class="n">x</span><span class="p">,</span> <span class="nb">int</span> <span class="n">y</span><span class="p">);</span>
 <span class="n">extern</span> <span class="n">char</span> <span class="o">*</span><span class="n">get_time</span><span class="p">();</span>
</pre></div>
</div>
<p>And now to compile it</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">unix</span> <span class="o">%</span> <span class="n">swig</span> <span class="o">-</span><span class="n">python</span> <span class="n">example</span><span class="o">.</span><span class="n">i</span>
<span class="n">unix</span> <span class="o">%</span> <span class="n">gcc</span> <span class="o">-</span><span class="n">c</span> <span class="n">example</span><span class="o">.</span><span class="n">c</span> <span class="n">example_wrap</span><span class="o">.</span><span class="n">c</span> \
        <span class="o">-</span><span class="n">I</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">include</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">1</span>
<span class="n">unix</span> <span class="o">%</span> <span class="n">ld</span> <span class="o">-</span><span class="n">shared</span> <span class="n">example</span><span class="o">.</span><span class="n">o</span> <span class="n">example_wrap</span><span class="o">.</span><span class="n">o</span> <span class="o">-</span><span class="n">o</span> <span class="n">_example</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
<p>Finally, the Python output</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">example</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">fact</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="go">120</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">my_mod</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="go">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">example</span><span class="o">.</span><span class="n">get_time</span><span class="p">()</span>
<span class="go">&#39;Sun Feb 11 23:01:07 1996&#39;</span>
<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
<p>As we can see, SWIG achieves the same result, but requires a slightly
more involved effort. But it’s worth it if you are targeting multiple
languages.</p>
</div>
<div class="section" id="python-c-api">
<h2>21.3. Python/C API<a class="headerlink" href="#python-c-api" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://docs.python.org/2/c-api/">C/Python API</a> is probably the
most widely used method - not for it’s simplicity but for the fact that
you can manipulate python objects in your C code.</p>
<p>This method requires your C code to be specifically written for
interfacing with Python code. All Python objects are represented as a
PyObject struct and the <code class="docutils literal"><span class="pre">Python.h</span></code> header file provides various
functions to manipulate it. For example if the PyObject is also a
PyListType (basically a list), then we can use the <code class="docutils literal"><span class="pre">PyList_Size()</span></code>
function on the struct to get the length of the list. This is equivalent
to calling <code class="docutils literal"><span class="pre">len(list)</span></code> in python. Most of the basic
functions/opertions that are there for native Python objects are made
available in C via the <code class="docutils literal"><span class="pre">Python.h</span></code> header.</p>
<p><strong>Example</strong></p>
<p>To write a C extension that adds all the elements in a python list. (all elements are numbers)</p>
<p>Let’s start with the final interface we’d like to have, here is the
python file that uses the C extension :</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1">#Though it looks like an ordinary python import, the addList module is implemented in C</span>
<span class="kn">import</span> <span class="nn">addList</span>

<span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="nb">print</span> <span class="s2">&quot;Sum of List - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">addList</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
</pre></div>
</div>
<p>The above looks like any ordinary python file, which imports and uses
another python module called <code class="docutils literal"><span class="pre">addList</span></code>. The only difference is that
the addList module is not written in Python at all, but rather in C.</p>
<p>Next we’ll have a look at the C code that get’s built into the
<code class="docutils literal"><span class="pre">addList</span></code> Python module. This may seem a bit daunting at first, but
once you understand the various components that go into writing the C
file, it’s pretty straight forward.</p>
<p><em>adder.c</em></p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span>//Python.h has all the required function definitions to manipulate the Python objects
#include &lt;Python.h&gt;

 //This is the function that is called from your python code
static PyObject* addList_add(PyObject* self, PyObject* args){

  PyObject * listObj;

  //The input arguments come as a tuple, we parse the args to get the various variables
  //In this case it&#39;s only one list variable, which will now be referenced by listObj
  if (! PyArg_ParseTuple( args, &quot;O&quot;, &amp;listObj))
    return NULL;

  //length of the list
  long length = PyList_Size(listObj);

  //iterate over all the elements
  int i, sum =0;
  for(i = 0; i &lt; length; i++){
    //get an element out of the list - the element is also a python objects
    PyObject* temp = PyList_GetItem(listObj, i);
    //we know that object represents an integer - so convert it into C long
    long elem = PyInt_AsLong(temp);
    sum += elem;
  }

  //value returned back to python code - another python object
  //build value here converts the C long to a python integer
  return Py_BuildValue(&quot;i&quot;, sum);
}

//This is the docstring that corresponds to our &#39;add&#39; function.
static char addList_docs[] =
    &quot;add( ): add all elements of the list\n&quot;;

/* This table contains the relavent info mapping -
  &lt;function-name in python module&gt;, &lt;actual-function&gt;,
  &lt;type-of-args the function expects&gt;, &lt;docstring associated with the function&gt;
*/
static PyMethodDef addList_funcs[] = {
    {&quot;add&quot;, (PyCFunction)addList_add, METH_VARARGS, addList_docs},
    {NULL, NULL, 0, NULL}
};

/*
addList is the module name, and this is the initialization block of the module.
&lt;desired module name&gt;, &lt;the-info-table&gt;, &lt;module&#39;s-docstring&gt;
*/
PyMODINIT_FUNC initaddList(void){
    Py_InitModule3(&quot;addList&quot;, addList_funcs,
                   &quot;Add all ze lists&quot;);
}
</pre></div>
</div>
<p>A step by step explanation :</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">&lt;Python.h&gt;</span></code> file consists of all the required types (to represent Python object types) and function definitions (to operate on the python objects).</li>
<li>Next we write the function which we plan to call from python. Conventionally the function names are {module-name}_{function-name}, which in this case is <code class="docutils literal"><span class="pre">addList_add</span></code>. More about the function later.</li>
<li>Then fill in the info table - which contains all the relevant info of the functions we desire to have in the module. Every row corresponds to a function, with the last one being a sentinel value (row of null elements).</li>
<li>Finally the module initialization block which is of the signature <code class="docutils literal"><span class="pre">PyMODINIT_FUNC</span> <span class="pre">init{module-name}</span></code>.</li>
</ul>
<p>The function <code class="docutils literal"><span class="pre">addList_add</span></code> accepts arguments as a PyObject type struct
(args is also a tuple type - but since everything in python is an
object, we use the generic PyObject notion). The incoming arguments is
parsed (basically split the tuple into individual elements) by
<code class="docutils literal"><span class="pre">PyArg_ParseTuple()</span></code>. The first parameter is the argument variable to
be parsed. The second argument is a string that tells us how to parse
each element in the args tuple. The character in the Nth position of the
string tells us the type of the Nth element in the args tuple, example -
‘i’ would mean integer, ‘s’ would mean string and ‘O’ would mean a
Python object. Next multiple arguments follow, these are where you would
like the <code class="docutils literal"><span class="pre">PyArg_ParseTuple()</span></code> function to store all the elements that
it has parsed. The number of such arguments is equal to the number of
arguments which the module function expects to receive, and positional
integrity is maintained. For example if we expected a string, integer
and a python list in that order, the function signature would be</p>
<div class="code c highlight-default"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">n</span><span class="p">;</span>
<span class="n">char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
<span class="n">PyObject</span><span class="o">*</span> <span class="nb">list</span><span class="p">;</span>
<span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;siO&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="nb">list</span><span class="p">);</span>
</pre></div>
</div>
<p>In this case we only have to extract a list object, and store it in the
variable <code class="docutils literal"><span class="pre">listObj</span></code>. We then use the <code class="docutils literal"><span class="pre">PyList_Size()</span></code> function on our
list object and get the length. This is similar to how you would call
<code class="docutils literal"><span class="pre">len(list)</span></code> in python.</p>
<p>Now we loop through the list, get each element using the
<code class="docutils literal"><span class="pre">PyList_GetItem(list,</span> <span class="pre">index)</span></code> function. This returns a PyObject*. But
since we know that the Python objects are also <code class="docutils literal"><span class="pre">PyIntType</span></code>, we just
use the <code class="docutils literal"><span class="pre">PyInt_AsLong(PyObj</span> <span class="pre">*)</span></code> function to get the required value. We
do this for every element and finally get the sum.</p>
<p>The sum is converted to a python object and is returned to the Python
code with the help of <code class="docutils literal"><span class="pre">Py_BuildValue()</span></code>. Here the “i” indicates that
the value we want to build is a python integer object.</p>
<p>Now we build the C module. Save the following code as <code class="docutils literal"><span class="pre">setup.py</span></code></p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1">#build the modules</span>

<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="k">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;addList&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>  \
      <span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s1">&#39;addList&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;adder.c&#39;</span><span class="p">])])</span>
</pre></div>
</div>
<p>and run</p>
<div class="code sh highlight-default"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
<p>This should now build and install the C file into the python module we
desire.</p>
<p>After all this hard work, we’ll now test if the module works -</p>
<div class="code python highlight-default"><div class="highlight"><pre><span></span><span class="c1">#module that talks to the C code</span>
<span class="kn">import</span> <span class="nn">addList</span>

<span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="nb">print</span> <span class="s2">&quot;Sum of List - &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; = &quot;</span> <span class="o">+</span>  <span class="nb">str</span><span class="p">(</span><span class="n">addList</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
</pre></div>
</div>
<p>And here is the output</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">Sum</span> <span class="n">of</span> <span class="n">List</span> <span class="o">-</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span>
</pre></div>
</div>
<p>So as you can see, we have developed our first successful C Python
extension using the Python.h API. This method does seem complex at
first, but once you get used to it it can prove to be quite useful.</p>
<p>Other ways to interface C code to Python is to use an alternative and
faster build of python - <a class="reference external" href="http://cython.org/">Cython</a>. But Cython is
a slightly different language than the main stream python we see. Hence
that method is not covered here.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="open_function.html" class="btn btn-neutral float-right" title="22. open Function" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="for_-_else.html" class="btn btn-neutral" title="20. For - Else" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Muhammad Yasoob Ullah Khalid.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>